{% extends "index.html" %}

{% block content %}
<style>
  body {
    font-family: 'Helvetica Neue', sans-serif;
    background: linear-gradient(135deg, #e6ddf1, #f3eafd);
  }

  h2 {
    color: #770fdb;
    font-size: 2rem;
    margin-bottom: 1.5rem;
  }

  .list, .targets {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
  }

  .item {
    background-color: #d8c4f2;
    padding: 1rem 2rem;
    border-radius: 20px;
    box-shadow: 4px 4px 0 #770fdb;
    font-size: 1.2rem;
    color: #000;
    cursor: grab;
    user-select: none;
    transition: all 0.25s ease;
    display: inline-block;
  }

  .item:hover {
    transform: translateY(-3px);
    box-shadow: 6px 6px 0 #770fdb;
  }

  .target {
    background-color: #fefaf1;
    border: 2px dashed #ccc;
    min-height: 80px;
    border-radius: 15px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 0.5rem;
    box-shadow: 4px 4px 0 #770fdb;
    transition: box-shadow 0.2s ease;
  }

  .target.over {
    background-color: #f5edff;
    border-color: #770fdb;
  }

  .target.pulsed {
    animation: pulse 0.4s ease;
  }

  @keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 #770fdb; }
    50% { transform: scale(1.02); box-shadow: 0 0 12px #770fdb; }
    100% { transform: scale(1); }
  }

  .target .drop-slot {
    margin-top: 0.5rem;
  }

  .feedback {
    font-weight: bold;
    font-size: 1.1rem;
    text-align: center;
    min-width: 300px;
  }

  .wiggle {
    animation: wiggle 0.4s ease;
  }

  @keyframes wiggle {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  button {
    background: #770fdb;
    border: none;
    color: white;
    padding: 0.8rem 1.5rem;
    border-radius: 10px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  button:hover {
    background-color: #5f0bb7;
  }
  
  /* Style for the global Undo button */
  #undoBtn {
    background: #ccc;
    color: #333;
  }
  
  #undoBtn:hover {
    background: #bbb;
  }
</style>

<br><br>

<div class="container">
  <h2>Q3. Drag the products into its use</h2>
  <br><br>

  <div class="row">
    <div class="col-md-5">
      <div class="list" id="draggables">
        <div class="item" draggable="true" data-match="serum">Serum</div>
        <div class="item" draggable="true" data-match="eye">Eye Cream</div>
        <div class="item" draggable="true" data-match="spot">Spot Treatment</div>
        <div class="item" draggable="true" data-match="moisturizer">Moisturizer</div>
      </div>
    </div>

    <div class="col-md-7">
      <div class="targets">
        <div class="target" data-accept="serum">
          <div>üåø Targets hydration & exfoliation</div>
          <div class="drop-slot"></div>
        </div>
        <div class="target" data-accept="spot">
          <div>üî¥ Clears breakouts or dark spots</div>
          <div class="drop-slot"></div>
        </div>
        <div class="target" data-accept="eye">
          <div>üëÅÔ∏è Hydrates delicate under-eye area</div>
          <div class="drop-slot"></div>
        </div>
        <div class="target" data-accept="moisturizer">
          <div>üîí Locks in hydration</div>
          <div class="drop-slot"></div>
        </div>
      </div>
    </div>
  </div>
  <br><br><br>

  <!-- Global control buttons -->
    <div class="feedback" id="dropWarning" style="display: none; color: #cc0000; margin-left: 0%;">
      ‚ö†Ô∏è You can only drop one item in each box!
    </div>
    <br>
    <center>
    <button id="undoBtn" onclick="undoLastDrop()">Undo</button>   <button onclick="checkMatches()">Submit</button>
    <div class="feedback" id="feedback"></div>
    <button id="nextBtn" class="back-btn" style="display: none; margin-left: 90%;" onclick="goToNext()">Next‚Üí</button>
    <br>
  </center>
  <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap gap-3">
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
  let draggedItem = null;
  const draggables = document.getElementById('draggables');
  // We'll maintain a drop history (stack) for undo purposes.
  let dropHistory = [];

  function addDragEvents(item) {
    item.addEventListener('dragstart', () => {
      draggedItem = item;
      item.classList.add('dragging');
    });

    item.addEventListener('dragend', () => {
      draggedItem = null;
      item.classList.remove('dragging');
    });
  }

  document.querySelectorAll('.item').forEach(addDragEvents);

  const targets = document.querySelectorAll('.target');

  targets.forEach(target => {
    const dropSlot = target.querySelector('.drop-slot');

    target.addEventListener('dragover', e => {
      e.preventDefault();
      target.classList.add('over');
    });

    target.addEventListener('dragleave', () => {
      target.classList.remove('over');
    });

    target.addEventListener('drop', () => {
      const dropWarning = document.getElementById('dropWarning');

      if (draggedItem) {
        // If the drop slot already has an item, warn the user
        if (dropSlot.children.length > 0) {
          target.classList.remove('over');
          target.classList.add('pulsed');

          dropWarning.style.display = 'block';
          dropWarning.classList.add('wiggle');
          setTimeout(() => {
            dropWarning.classList.remove('wiggle');
            dropWarning.style.display = 'none';
          }, 2000);
          return;
        }

        // Remove the item from any previous slot
        document.querySelectorAll('.drop-slot').forEach(slot => {
          if (slot.contains(draggedItem)) {
            slot.innerHTML = '';
          }
        });

        // Place the dragged item into the drop slot
        dropSlot.innerHTML = '';
        dropSlot.appendChild(draggedItem);
        target.classList.remove('over');
        target.classList.add('pulsed');
        setTimeout(() => target.classList.remove('pulsed'), 400);

        // Record this drop in history for the Undo button
        dropHistory.push({ dropSlot: dropSlot, item: draggedItem });
      }
    });
  });

  // Global Undo function: remove the last dropped item and return it to the draggable list
  function undoLastDrop() {
    if (dropHistory.length > 0) {
      const lastDrop = dropHistory.pop();
      const { dropSlot, item } = lastDrop;
      if (dropSlot.contains(item)) {
        dropSlot.removeChild(item);
        // Append the item back to the main draggable list.
        draggables.appendChild(item);
      }
    }
  }

  function checkMatches() {
    const feedback = document.getElementById('feedback');
    feedback.classList.remove('wiggle');

    const userAnswers = {};
    let correct = 0;

    const correctMapping = {
      serum: "Serum",
      eye: "Eye Cream",
      spot: "Spot Treatment",
      moisturizer: "Moisturizer"
    };

    targets.forEach(target => {
      const dropped = target.querySelector('.drop-slot .item');
      if (dropped) {
        const droppedText = dropped.textContent.trim();
        const expectedKey = target.dataset.accept;
        userAnswers[expectedKey] = droppedText;
        if (droppedText === correctMapping[expectedKey]) {
          correct++;
        }
      }
    });

    if (correct === Object.keys(correctMapping).length) {
      document.getElementById("nextBtn").style.display = "inline-block";
      feedback.textContent = 'üéâ All correct! You nailed it!';
      feedback.style.color = '#008000';
      confetti({ particleCount: 120, spread: 90, origin: { y: 0.6 } });
    } else {
      document.getElementById("nextBtn").style.display = "inline-block";
      feedback.textContent = `‚ùå You got ${correct} out of ${Object.keys(correctMapping).length} correct. Try again!`;
      feedback.style.color = '#cc0000';
      feedback.classList.add('wiggle');
    }

    // Submit and save the user's progress
    fetch("/submit-quiz/3", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ answer: userAnswers })
    })
    .then(res => res.json())
    .then(() => fetch("/save-progress", {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    }))
    .then(res => res.json())
    .then(() => {
      console.log("‚úÖ Progress saved to userdata.json");
    })
    .catch(err => console.error("‚ùå Something went wrong", err));
  }
</script>
{% endblock %}
